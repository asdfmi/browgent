{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agent-flow.dev/schema/workflow.json",
  "type": "object",
  "required": ["nodes"],
  "additionalProperties": false,
  "properties": {
    "name": { "type": "string" },
    "description": { "type": "string" },
    "start": { "type": "string", "minLength": 1 },
    "nodes": {
      "type": "array",
      "items": { "$ref": "#/$defs/node" },
      "default": []
    },
    "edges": {
      "type": "array",
      "items": { "$ref": "#/$defs/edge" },
      "default": []
    }
  },
  "$defs": {
    "node": {
      "oneOf": [
        { "$ref": "#/$defs/navigateNode" },
        { "$ref": "#/$defs/waitNode" },
        { "$ref": "#/$defs/scrollNode" },
        { "$ref": "#/$defs/clickNode" },
        { "$ref": "#/$defs/fillNode" },
        { "$ref": "#/$defs/pressNode" },
        { "$ref": "#/$defs/logNode" },
        { "$ref": "#/$defs/scriptNode" },
        { "$ref": "#/$defs/extractTextNode" }
      ]
    },
    "edge": {
      "type": "object",
      "required": ["id", "from"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "from": { "type": "string", "minLength": 1 },
        "to": {
          "anyOf": [
            { "type": "string", "minLength": 1 },
            { "type": "null" }
          ]
        },
        "priority": { "type": "number" },
        "label": { "type": "string" },
        "condition": {
          "anyOf": [
            { "$ref": "#/$defs/condition" },
            { "type": "null" }
          ]
        },
        "metadata": {
          "anyOf": [
            { "type": "object" },
            { "type": "null" }
          ]
        }
      }
    },
    "xpathTarget": {
      "type": "object",
      "required": ["xpath"],
      "additionalProperties": false,
      "properties": {
        "xpath": { "type": "string", "minLength": 1 }
      }
    },
    "success": {
      "type": "object",
      "required": ["condition"],
      "additionalProperties": false,
      "properties": {
        "timeout": { "type": "number", "exclusiveMinimum": 0 },
        "condition": { "$ref": "#/$defs/condition" }
      }
    },
    "condition": {
      "type": "object",
      "oneOf": [
        {
          "required": ["visible"],
          "additionalProperties": false,
          "properties": {
            "visible": { "$ref": "#/$defs/xpathTarget" }
          }
        },
        {
          "required": ["exists"],
          "additionalProperties": false,
          "properties": {
            "exists": { "$ref": "#/$defs/xpathTarget" }
          }
        },
        {
          "required": ["urlIncludes"],
          "additionalProperties": false,
          "properties": {
            "urlIncludes": { "type": "string" }
          }
        },
        {
          "required": ["delay"],
          "additionalProperties": false,
          "properties": {
            "delay": { "type": "number", "minimum": 0 }
          }
        },
        {
          "required": ["script"],
          "additionalProperties": false,
          "properties": {
            "script": {
              "type": "object",
              "required": ["code"],
              "additionalProperties": false,
              "properties": {
                "code": { "type": "string" }
              }
            }
          }
        }
      ]
    },
    "navigateNode": {
      "type": "object",
      "required": ["id", "type", "url", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "navigate" },
        "url": { "type": "string", "minLength": 1 },
        "waitUntil": { "type": "string" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" }
      }
    },
    "waitNode": {
      "type": "object",
      "required": ["id", "type", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "wait" },
        "label": { "type": "string" },
        "success": { "$ref": "#/$defs/success" }
      }
    },
    "scrollNode": {
      "type": "object",
      "required": ["id", "type", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "scroll" },
        "dx": { "type": "number" },
        "dy": { "type": "number" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" }
      },
      "anyOf": [
        { "required": ["dx"] },
        { "required": ["dy"] }
      ]
    },
    "clickNode": {
      "type": "object",
      "required": ["id", "type", "xpath", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "click" },
        "xpath": { "type": "string", "minLength": 1 },
        "options": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "button": { "type": "string" },
            "clickCount": { "type": "integer", "minimum": 1 },
            "delay": { "type": "number", "minimum": 0 },
            "timeout": { "type": "number", "minimum": 0 }
          }
        },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" }
      }
    },
    "fillNode": {
      "type": "object",
      "required": ["id", "type", "xpath", "value", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "fill" },
        "xpath": { "type": "string", "minLength": 1 },
        "value": { "type": "string" },
        "clear": { "type": "boolean" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" }
      }
    },
    "pressNode": {
      "type": "object",
      "required": ["id", "type", "xpath", "key", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "press" },
        "xpath": { "type": "string", "minLength": 1 },
        "key": { "type": "string", "minLength": 1 },
        "delay": { "type": "number", "minimum": 0 },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" }
      }
    },
    "logNode": {
      "type": "object",
      "required": ["id", "type", "label", "message", "target", "level"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "log" },
        "message": { "type": "string" },
        "target": { "type": "string" },
        "level": { "type": "string" },
        "label": { "type": "string" },
        "success": { "$ref": "#/$defs/success" }
      }
    },
    "scriptNode": {
      "type": "object",
      "required": ["id", "type", "code", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "script" },
        "code": { "type": "string" },
        "as": { "type": "string" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" }
      }
    },
    "extractTextNode": {
      "type": "object",
      "required": ["id", "type", "xpath", "as", "label"],
      "additionalProperties": false,
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "type": { "const": "extract_text" },
        "xpath": { "type": "string", "minLength": 1 },
        "as": { "type": "string" },
        "success": { "$ref": "#/$defs/success" },
        "label": { "type": "string" }
      }
    }
  }
}
